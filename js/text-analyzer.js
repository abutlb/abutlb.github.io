// Global variables
let textData = []; // Will hold the processed text data
let csvData = []; // Will hold the raw CSV data
let selectedColumn = ""; // The column selected for analysis
let themeData = {}; // Will hold the theme data from JSON
let negativeKeywords = []; // Will hold negative keywords from JSON

// Instead of fetching JSON, we'll include the data directly
function getAnalyzerData() {
    return {
        "themes": {
            "السعر": [
                "سعر", "غالي", "غالية", "رخيص", "رخيصة", "التكلفة", "مكلف", "الاسعار", "السعر مرتفع", "سعركم عالي", 
                "الاسعار مرتفعة", "أسعار تنافسية", "سعر مناسب", "سعر معقول", "أسعاركم منافسة", "أسعار مناسبة",
                "سعر مبالغ", "شحن مكلف", "استغلال", "أقل من السوق", "الأسعار مرتفعة جداً", "مقارنة بالمواقع الأخرى",
                "أسعار غالية", "أسعار مبالغ فيها", "مرتفع جداً", "عالي جداً", "أغلى من المتوقع", "باهظ", "توفير",
                "رسوم الشحن", "يستحق السعر", "تكلفة إضافية", "رسوم مخفية", "ضرائب", "خصم", "تقسيط", "رسوم إضافية",
                "سعر النهائي", "ارتفع فجأة", "تضاعفت", "مجاني", "أعلى بكثير", "طلب مبلغ إضافي"
            ],
            "الخدمة": [
                "الخدمة", "الخدمات", "خدمه", "موظف", "الموظف", "تعامل", "استقبال", "خدمة العملاء", "استقبلني", 
                "ما خدموني", "سحب علي", "خدمة ممتازة", "موظفين محترمين", "تعامل راقي", "خدمة رائعة",
                "الاهتمام بالعملاء", "موظفي الاستقبال", "خدمة التوصيل", "وقح", "اسلوبهم سيء", "احترام للعميل",
                "سياسة الإرجاع", "مرنة", "سياسة استرداد", "سياسة استبدال", "سياسة الضمان", "خدمة ما بعد البيع",
                "متعاونين", "ودودين", "احترافي", "مهذب", "الاستبدال", "مندوب التوصيل", "غير محترف",
                "غير مهذب", "استفزازي", "تعامل سيء", "استبدال المنتج", "الاسترجاع", "سهل", "دون تعقيد",
                "خدمة العملاء سيئة", "زبون دائم", "عميل"
            ],
            "السرعة": [
                "بطيء", "بطء", "تأخير", "تأخر", "يتأخر", "انتظار", "ما وصل", "ما رد", "طولتوا", "ليش تأخر", 
                "الطلب اتأخر", "سريع", "سرعة", "قبل الموعد", "سرعة الرد", "استجابة سريعة", "سريع التحميل",
                "وقت طويل", "لم يصل بعد", "متأخراً عن الموعد", "يستغرق وقتاً طويلاً", "التأخير غير مبرر",
                "في نفس اليوم", "وقت قياسي", "فوري", "بطء في التحميل", "توصيل سريع", "سريع الاستجابة",
                "بطيء جداً", "الانتظار طويل", "توصيل للمنزل", "استغرق وقتاً أطول", "أكثر من 10 أيام", 
                "أكثر من شهر", "تأخر الرد", "الوقت المتوقع", "استغرقت وقتاً طويلاً", "قبل الوقت المتوقع"
            ],
            "الجودة": [
                "جودة", "تعطل", "تعطل الجهاز", "ما يشتغل", "ما يعمل", "خربان", "يتعلق", "المنتج خرب", "غير أصلي", 
                "تقليد", "جودة عالية", "جودة ممتازة", "أصلي 100%", "تجاوز توقعاتي", "مقلد", "تالف", "مكسور",
                "ناقص", "لا يعمل", "لا يطابق المواصفات", "غير صالح للاستخدام", "المنتج ليس كما هو موضح",
                "خداع", "المنتج لا يتطابق", "حجم المنتج أصغر", "أصغر مما هو موضح", "مختلف عن الصور",
                "المواصفات المذكورة", "لا يطابق الوصف", "ليس كما هو موصوف", "تغير لونه", "متين", "مواد عالية الجودة",
                "عيوب تصنيع", "يتعطل بسرعة", "مستعمل", "عيوب خطيرة", "لا يوجد تطابق بين المنتج المستلم والموصوف",
                "فائض الصلاحية", "قارب على الانتهاء", "مختلف تماماً عما طلبته", "به عيوب", "يستحق الشراء", 
                "يتعطل بعد فترة قصيرة", "ليس بنفس الجودة", "كمية المنتج أقل", "لا يطابق مع المواصفات"
            ],
            "الواجهة/التطبيق": [
                "تطبيق", "الواجهة", "صعب الاستخدام", "واجهة غير واضحة", "يتعلق", "كراش", "ما يفتح", "يتجمد", 
                "ما يشتغل", "معقد", "سهل الاستخدام", "واجهة جميلة", "يعمل بسلاسة", "سهل التصفح", "سهولة البحث",
                "يتعطل", "يتوقف باستمرار", "غير منظم", "صعب العثور", "واجهة سيئة", "تصميم سيء", "غير متوافق",
                "مشاكل فنية", "بطيء التحميل", "يستهلك البطارية", "يستنزف البيانات", "سهولة التسجيل",
                "نظام البحث", "ضعيف", "نتائج دقيقة", "صور المنتجات مضللة", "يعرض منتجات غير متوفرة",
                "يستهلك الكثير من بطارية", "يتوقف فجأة", "تظهر أخطاء متكررة", "غير آمنة", "يطلب معلومات شخصية"
            ],
            "الدفع": [
                "دفع", "مدفوع", "ما انخصم", "المبلغ", "خرب الدفع", "مشاكل الدفع", "بطاقة", "رفض الدفع", 
                "ما قدرت أدفع", "تجربة الدفع سلسة", "الدفع الإلكتروني", "آمن", "خصم المبلغ مرتين", "إلغاء الطلب",
                "تأكيد الطلب", "استرداد الأموال", "فاتورة", "إيصال", "طرق الدفع", "خصم إضافي", "تقسيط",
                "دفع عند الاستلام", "نظام محاسبي", "الدفع الآمن", "فشل عملية الدفع", "رسوم إضافية",
                "مشكلة في نظام الدفع", "لم يتم تأكيد", "استرداد المبلغ", "تم خصم المبلغ", "لم يتم تأكيد الطلب",
                "دفع فوري", "خيارات الدفع", "الدفع النهائي", "فشل عملية الدفع"
            ],
            "الطلب والشحن": [
                "طلب", "شحن", "توصيل", "وصل", "الطلب اتأخر", "ما استلمت", "ضايع", "تأخير في الشحن", "وصل ناقص", 
                "شركة الشحن", "سرعة الشحن", "الشحن سريع", "التغليف ممتاز", "شحن مجاني", "متابعة الطلب",
                "التغليف آمن", "حالة الطلب", "لا يوجد متابعة", "تتبع الطلب", "وقت الاستلام", "التسليم",
                "تغليف هدية", "تعبئة", "عنوان خطأ", "مكان التسليم", "التوصيل المجاني", "تتبع الشحنة",
                "توصيل للمنزل", "العنوان الصحيح", "تأكيد الطلب", "العبوة لا تحمي المنتج", "تعرض للكسر", 
                "التغليف بسيط", "لا يحمي المنتج", "التغليف غير آمن", "المنتج محمي جيداً", "التعبئة", 
                "تسليم الطلب", "وصل الطلب", "لم يتم تسليم", "عملية إرجاع", "تالف وغير محمي"
            ],
            "الدعم الفني": [
                "الدعم", "الرد", "ما يردون", "ما تواصلوا", "رد متأخر", "اتصلت", "ما في تواصل", "تكلمت معهم", 
                "اتصلت وما احد رد", "سريع الاستجابة", "حل المشكلة", "سرعة استجابتكم", "التواصل صعب", "لا أحد يرد",
                "خدمة ما بعد البيع", "ضمان", "استفسار", "سؤال", "التفاعل مع الشكاوى", "المتابعة",
                "دردشة مباشرة", "رقم الهاتف", "وقت انتظار", "مركز المساعدة", "منصة الدردشة المباشرة",
                "وفرت علي الكثير من الوقت", "صعوبة التواصل", "لم يتم الرد على شكواي", "قسم الأسئلة المتكررة",
                "لا يجيب", "اضطررت للتواصل عدة مرات", "بطيء وغير فعال", "تجربة الدعم الفني", "محبطة", "رقم تواصل"
            ],
            "اللغة/الكتابة": [
                "اخطاء", "املاء", "كتابة", "لغة", "ما فهمت", "غامض", "غير مفهوم", "ترجمة", "مش واضح", "الشرح مو كافي",
                "لا توجد تعليمات واضحة", "تعليمات", "غير واضح", "غير واضحة", "وصف", "شرح", "دليل الاستخدام",
                "التوثيق", "المعلومات ناقصة", "معلومات غير دقيقة", "المحتوى المكتوب", "الترجمة سيئة",
                "تفاصيل المنتج", "إرشادات", "دليل مرفق", "فيديوهات توضيحية", "الوصف التفصيلي", "غير دقيق",
                "لا يوجد دليل استخدام", "وصف دقيق للمنتج", "معلومات شاملة", "معلومات مفصلة", "الأسئلة الشائعة"
            ],
            "التجربة العامة": [
                "حلو", "سيئ", "جميل", "ممتاز", "مره كويس", "حرام", "نصب", "افضل", "اسوء", "سيء جدًا", "شكراً", 
                "يسلمو", "لا تعليق", "بدون مشاكل", "تجربة ممتازة", "تجربة سيئة", "أنصح", "لن أنصح", "زبون دائم",
                "تجربة شراء", "ندمت", "سعيد جداً", "لن أتعامل", "أفضل متجر", "راضي", "غير راضي", "مخيب للآمال",
                "أثق بمتجركم", "تجربة التسوق", "من البداية للنهاية", "توقعات", "سأعود", "أبداً مو راضي",
                "ندمان", "أزعجتوني", "ما راح أكرر", "كرهت التعامل", "أكره", "كرههت", "فوضى", "أبداً مو كويس"
            ],
            "العروض والتسوق": [
                "عروض", "خصومات", "عروض حصرية", "تسوق", "تجربة تسوق", "ممتعة", "منتجات متنوعة", "تصنيف المنتجات",
                "العروض الأسبوعية", "العروض وهمية", "غير حقيقية", "متجددة", "قيمة", "شراء", "الخصومات الموسمية",
                "كود خصم", "كوبون", "توفير", "العروض الترويجية", "مقارنة أسعار", "تنوع المنتجات", "كتالوج",
                "تخفيضات", "هدايا مجانية", "عينات مجانية", "عروض الولاء", "نقاط المكافآت", "حزم خاصة",
                "المنتج غير متوفر دائماً", "رغم ظهوره على الموقع", "لم يعمل كود الخصم", "العروض المعلنة",
                "غير متوفرة عند الطلب", "الخصم المعلن عنه", "لا ينطبق على جميع المنتجات", "محدودة جداً",
                "غير متوفر", "تنتهي بسرعة", "مزعجة ومتكررة", "اتصالات مزعجة"
            ],
            "التوافر والمخزون": [
                "متوفر", "غير متوفر", "نفذت الكمية", "خارج المخزون", "متوفر حالياً", "غير متوفرة حالياً",
                "يظهر متوفر", "يظهر غير متوفر", "محدود الكمية", "آخر قطعة", "إشعار عند التوفر",
                "إعادة تخزين", "مؤقتاً غير متوفر", "يعود قريباً", "قطع محدودة", "حصري",
                "المنتج غير متوفر دائماً رغم ظهوره على الموقع", "قديمة وليست حديثة", "الموقع يعرض منتجات غير متوفرة حالياً"
            ]
        },
        "negative_keywords": [
            "سيء", "سيئ", "سيئة", "اسوء", "أسوأ", "تجربة سيئة", "تجربة فاشلة", "فاشل", 
            "ما عجبني", "ما أعجبني", "مافادني", "زفت", "نصب", "حرامية", "حرامي", 
            "ما يرد", "ما يشتغل", "خربان", "يعلق", "ما يستاهل", "خدمة سيئة", 
            "الطلب اتأخر", "طلب ناقص", "تأخير مبالغ", "رد سيء", "اسلوبهم سيء", 
            "وقحين", "مافي احترام", "مافي رد", "كرهت التعامل", "أكره", "كرههت", 
            "أبداً مو راضي", "ندمان", "ندمت", "أزعجتوني", "ما راح أكرر", 
            "أبداً مو كويس", "طلبت وما وصل", "تواصلت وما أحد رد", "فوضى", 
            "مزعج", "مزعجين", "استغلال", "سعر مبالغ", "حرام عليكم", "خدمة العملاء سيئة",
            "غالي جداً", "مرتفعة جداً", "تأخر", "غير مقبول", "بطيء جداً", "لا يرد", 
            "تالف", "غير صالح", "لا يوجد احترام", "لن أتعامل", "خداع", "ليس كما موضح",
            "لم يصل بعد", "يتعطل", "ناقص", "غير مكتملة", "مكسور", "معقدة جداً",
            "لا تلتزم بالمواعيد", "مقلد", "وليس أصلي", "صعب جداً", "لا يعمل",
            "لا يستحق السعر", "خصم المبلغ مرتين", "مكلف جداً", "مختلف تماماً",
            "العروض وهمية", "غير حقيقية", "لا يوجد متابعة", "سيئة جداً",
            "لا يوجد ضمان حقيقي", "غالية جداً", "غير منظم", "متأخراً جداً",
            "غير واضحة", "أصغر مما موضح", "ندمت على الشراء", "مختلفة تماماً",
            "وقحاً جداً", "لا يتطابق", "لن أنصح", "مشكلة في نظام الدفع",
            "لم يصلني إشعار", "استغرق وقتاً أطول", "طويل جداً", "لا أستطيع التواصل",
            "يتجمد كثيراً", "رسوم مرتفعة", "ناقصاً", "غير كاملة", "تأخر الرد",
            "غير مستحق", "غير واضحة", "مزعجة جداً", "لم يتم تأكيد", "مشاكل فنية مستمرة",
            "معقدة وتستغرق", "متأخراً وبحالة سيئة", "لا يوجد خيارات", "مضللة وغير دقيقة",
            "معقدة وغير واضحة", "غير محترف", "غير مهذب", "لم يعمل كود الخصم",
            "عدم احترام خصوصية", "اتصالات مزعجة", "ارتفع فجأة", "مستعمل وليس جديداً",
            "لم أتمكن من إلغاء", "تنتهي بسرعة", "استغرقت وقتاً طويلاً", "لا تحمي المنتج",
            "لم يتم تسليم", "اضطررت للتواصل عدة مرات", "ليس بالجودة المتوقعة",
            "يستهلك الكثير", "ضعيف ولا يعطي", "يطلب معلومات شخصية كثيرة",
            "محدودة جداً", "غير متوفر", "مرتين", "مزعجة ومتكررة", "تظهر أخطاء متكررة",
            "مختلف تماماً", "يتوقف فجأة", "غير كافية", "أكثر من 10 أيام",
            "دون إبلاغي", "بدون فاتورة", "به عيوب تصنيع", "تغير عند", 
            "طلب مبلغ إضافي", "لا يغطي العيوب", "لم يتم الرد على شكواي",
            "غير متوفرة حالياً", "مضللة وتخفي العيوب", "يتعطل بعد فترة قصيرة",
            "أكثر من شهر", "قديمة وليست حديثة", "استفزازي", "تضاعفت عند الدفع",
            "غير آمنة", "الإعلانات المضللة", "ليس بنفس الجودة", "كمية المنتج أقل",
            "تالف ويبدو مستعملاً", "مرهقة", "لا توجد خيارات", "بسيط جداً",
            "وهمية", "قسم الأسئلة المتكررة لا يجيب", "بطيء وغير فعال",
            "لا ينطبق على جميع", "غير دقيق", "لا يوجد استرجاع", "أعلى بكثير",
            "صعوبة التواصل", "تالف وغير محمي", "غير منظمة", "محبطة",
            "دون موافقتي", "تعامل سيء", "غير صالح للاستخدام", "الانتظار طويل",
            "معقدة وتستغرق", "نظام البحث في الموقع ضعيف", "لا يوجد تطابق", "العبوة لا تحمي",
            "تعرض للكسر", "فائض الصلاحية", "قارب على الانتهاء", "صور المنتجات مضللة"
        ]
    };
}


// Load the analyzer data
function loadAnalyzerData() {
    try {
        const data = getAnalyzerData();
        themeData = data.themes;
        negativeKeywords = data.negative_keywords;
        console.log("Theme data loaded successfully", {
            themeCount: Object.keys(themeData).length,
            negativeKeywordsCount: negativeKeywords.length
        });
        
        // Debug: Print some negative keywords to verify they loaded
        if (negativeKeywords.length > 0) {
            console.log("Sample negative keywords:", negativeKeywords.slice(0, 5));
        } else {
            console.error("No negative keywords loaded");
        }
    } catch (error) {
        console.error("Error loading theme data:", error);
        showToast("خطأ في تحميل بيانات التحليل", "error");
    }
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyzerData();
    setupDarkMode();
    setupTabSwitching();
    setupFileUpload();
    setupEventListeners();
    updateCurrentYear();
});

// Setup dark mode toggle
function setupDarkMode() {
    const themeToggle = document.getElementById('themeToggle');
    const themeSwitch = document.getElementById('themeSwitch');
    
    // Check for saved theme preference or use preferred color scheme
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        themeSwitch.checked = true;
    }
    
    themeToggle.addEventListener('click', function() {
        document.documentElement.classList.toggle('dark');
        themeSwitch.checked = document.documentElement.classList.contains('dark');
        
        // Save preference to localStorage
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });
}

// Setup tab switching
function setupTabSwitching() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('opacity-80');
                btn.classList.remove('opacity-100');
            });
            
            // Add active class to current button
            this.classList.add('active', 'opacity-100');
            this.classList.remove('opacity-80');
            
            // Hide all tab contents
            tabContents.forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('block');
            });
            
            // Show the selected tab content
            const tabId = this.getAttribute('data-tab');
            const tabContent = document.getElementById(`${tabId}-tab`);
            
            if (tabContent) {
                tabContent.classList.remove('hidden');
                tabContent.classList.add('block');
            } else {
                console.error(`Tab content with ID "${tabId}-tab" not found`);
            }
        });
    });
    
    // If no tab is active by default, activate the first tab
    let hasActiveTab = false;
    tabButtons.forEach(btn => {
        if (btn.classList.contains('active')) {
            hasActiveTab = true;
            // Ensure the corresponding tab content is visible
            const tabId = btn.getAttribute('data-tab');
            const tabContent = document.getElementById(`${tabId}-tab`);
            if (tabContent) {
                tabContent.classList.remove('hidden');
                tabContent.classList.add('block');
            }
        }
    });
    
    if (!hasActiveTab && tabButtons.length > 0) {
        tabButtons[0].click();
    }
}


// Setup file upload
function setupFileUpload() {
    const dropArea = document.querySelector('.transition.bg-white');
    const fileInput = document.getElementById('csvFileInput');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('border-red-400', 'dark:border-red-500');
    }
    
    function unhighlight() {
        dropArea.classList.remove('border-red-400', 'dark:border-red-500');
    }
    
    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length) {
            fileInput.files = files;
            handleFiles(files);
        }
    }
    
    dropArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', function() {
        if (this.files.length) {
            handleFiles(this.files);
        }
    });
    
    function handleFiles(files) {
        const file = files[0];
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            showToast('يرجى تحميل ملف CSV فقط', 'error');
            return;
        }
        
        parseCSVFile(file);
    }
}

// Parse CSV file using PapaParse
function parseCSVFile(file) {
    Papa.parse(file, {
        header: true,
        encoding: "UTF-8",
        complete: function(results) {
            if (results.data && results.data.length > 0) {
                csvData = results.data;
                populateColumnSelector(results.meta.fields);
                showDataPreview(results.data);
                updateDataStatistics(results.data);
                showToast(`تم تحميل ${results.data.length} سجل بنجاح`, 'success');
            } else {
                showToast('لم يتم العثور على بيانات في الملف', 'error');
            }
        },
        error: function(error) {
            console.error('Error parsing CSV:', error);
            showToast('خطأ في تحليل ملف CSV', 'error');
        }
    });
}

// Populate column selector with CSV headers
function populateColumnSelector(fields) {
    const columnSelector = document.getElementById('columnSelector');
    const container = document.getElementById('columnSelectionContainer');
    
    // Clear previous options
    columnSelector.innerHTML = '<option value="">-- يرجى اختيار عمود --</option>';
    
    // Add new options
    fields.forEach(field => {
        const option = document.createElement('option');
        option.value = field;
        option.textContent = field;
        columnSelector.appendChild(option);
    });
    
    // Show the column selector
    container.classList.remove('hidden');
}

// Show data preview
function showDataPreview(data) {
    const previewElement = document.getElementById('dataPreview');
    const dataCount = document.getElementById('dataCount');
    
    // Update record count
    dataCount.textContent = `${data.length} سجلات`;
    
    // Clear previous content
    previewElement.innerHTML = '';
    
    // Create preview table
    const table = document.createElement('table');
    table.className = 'w-full text-sm';
    
    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    Object.keys(data[0]).forEach(key => {
        const th = document.createElement('th');
        th.className = 'text-right py-2 px-2 border-b border-gray-200 dark:border-gray-600';
        th.textContent = key;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create body
    const tbody = document.createElement('tbody');
    
    // Add up to 10 rows for preview
    data.slice(0, 10).forEach(row => {
        const tr = document.createElement('tr');
        
        Object.values(row).forEach(value => {
            const td = document.createElement('td');
            td.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600';
            td.textContent = value || '-';
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    previewElement.appendChild(table);
}

// Calculate average text length
function calculateAverageTextLength(data, column) {
    if (!data.length || !column) return 0;
    
    const textLengths = data
        .map(row => row[column] ? row[column].split(/\s+/).filter(word => word.trim()).length : 0)
        .filter(length => length > 0);
    
    return textLengths.length > 0 
        ? Math.round(textLengths.reduce((sum, length) => sum + length, 0) / textLengths.length) 
        : 0;
}

// Update data statistics
function updateDataStatistics(data) {
    const recordsCount = document.getElementById('recordsCount');
    recordsCount.textContent = data.length;
    
    // For average length, we would need to know which column to analyze
    const columnSelector = document.getElementById('columnSelector');
    columnSelector.addEventListener('change', function() {
        selectedColumn = this.value;
        
        if (selectedColumn) {
            const avgLength = document.getElementById('avgLength');
            avgLength.textContent = calculateAverageTextLength(data, selectedColumn);
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Manual input handling
    const manualInput = document.getElementById('manualInput');
    manualInput.addEventListener('input', function() {
        if (this.value.trim()) {
            const lines = this.value.trim().split('\n').filter(line => line.trim());
            
            // Create data structure similar to CSV parsing
            const data = lines.map(line => ({ text: line }));
            
            csvData = data;
            selectedColumn = 'text';
            
            // Update UI
            updateDataStatistics(data);
            showDataPreview(data);
            
            // Update average length immediately for manual input
            const avgLength = document.getElementById('avgLength');
            avgLength.textContent = calculateAverageTextLength(data, 'text');
        }
    });
    
    // Clear input button
    const clearInputBtn = document.getElementById('clearInputBtn');
    clearInputBtn.addEventListener('click', function() {
        document.getElementById('manualInput').value = '';
        document.getElementById('csvFileInput').value = '';
        csvData = [];
        selectedColumn = '';
        textData = [];
        
        // Reset UI
        document.getElementById('dataPreview').innerHTML = '<div class="h-full flex items-center justify-center text-gray-500 dark:text-gray-400"><div class="text-center"><i class="fas fa-file-alt text-2xl mb-2"></i><p>قم بتحميل ملف CSV أو أدخل بيانات لرؤية المعاينة هنا...</p></div></div>';
        document.getElementById('dataCount').textContent = '0 سجلات';
        document.getElementById('recordsCount').textContent = '0';
        document.getElementById('avgLength').textContent = '0';
    });
    
    function getExampleDataset() {
        return [
            // Positive comments (210)
            "الخدمة كانت ممتازة والموظفين محترمين جداً",
            "سعر المنتج مناسب جداً مقارنة بالجودة العالية",
            "الشحن سريع والتغليف ممتاز، وصل المنتج بدون أي ضرر",
            "موظفي خدمة العملاء متعاونين وحلوا مشكلتي بسرعة",
            "التطبيق سهل الاستخدام وواجهته جميلة جداً",
            "المنتج يستحق السعر، جودته عالية جداً",
            "أسعار مناسبة ومنتجات ذات جودة عالية",
            "سرعة الشحن ممتازة، وصل الطلب قبل الموعد المتوقع",
            "خدمة عملاء رائعة وتعامل محترم",
            "التوصيل كان سريع جداً والسائق محترم",
            "منتجات أصلية 100% وبسعر معقول",
            "أحب هذا المتجر، دائماً يقدم أفضل الخدمات",
            "تجربة شراء ممتازة من الألف إلى الياء",
            "شكراً لكم على الاهتمام بالعملاء وسرعة الرد",
            "الموقع سهل التصفح ويعرض المنتجات بشكل واضح",
            "أسعار تنافسية مقارنة بالمواقع الأخرى",
            "جودة المنتج فاقت توقعاتي، أنا سعيد جداً بالشراء",
            "التعامل راقي والمنتج ممتاز",
            "الدعم الفني سريع الاستجابة وحل المشكلة بسرعة",
            "التطبيق يعمل بسلاسة وبدون أي مشاكل",
            "موظفي الاستقبال ودودين ومتعاونين",
            "خدمة الشحن سريعة جداً ومتابعة الطلب سهلة",
            "يمكنني متابعة طلبي بسهولة عبر التطبيق",
            "حقاً أنتم أفضل متجر إلكتروني تعاملت معه",
            "كل منتجاتكم ذات جودة عالية وأسعار معقولة",
            "تجربة الدفع سلسة وآمنة، وهذا ما أحبه",
            "التغليف آمن جداً ويحمي المنتج بشكل ممتاز",
            "أنا زبون دائم عندكم بسبب جودة الخدمة",
            "مجموعة متنوعة من المنتجات وأسعار مناسبة",
            "موقعكم مرتب بشكل جميل ويسهل البحث",
            "منتج ممتاز جداً وسعره معقول مقارنة بالمنافسين",
            "سرعة في الرد على الاستفسارات، شكراً لكم",
            "تعاملكم راقي وخدمتكم ممتازة",
            "أحب التسوق من متجركم لأن المنتجات أصلية",
            "الشحن مجاني وهذا رائع جداً",
            "واجهة التطبيق سهلة الاستخدام ومريحة للعين",
            "العروض والخصومات جذابة ومستمرة",
            "الدفع الإلكتروني يعمل بشكل سلس وآمن",
            "سياسة الإرجاع مرنة وهذا ما أحبه في متجركم",
            "تجربة تسوق ممتعة من البداية للنهاية",
            "شكراً على الهدية المجانية مع الطلب، لفتة جميلة",
            "خدمة التوصيل للمنزل سريعة وموثوقة",
            "أنصح الجميع بالتعامل مع متجركم الرائع",
            "المنتج تجاوز توقعاتي من ناحية الجودة",
            "موظفي خدمة العملاء متعاونين جداً وصبورين",
            "التطبيق سريع ولا يوجد أي تأخير في التحميل",
            "أسعاركم منافسة ومعقولة جداً",
            "المنتج أصلي 100% وبسعر أقل من السوق",
            "سهولة الشراء وتتبع الطلب خدمة رائعة",
            "خدمة العملاء ممتازة حتى بعد الشراء",
            "أحب سرعة استجابتكم للاستفسارات والشكاوى",
            "تجربة ممتازة في كل مرة أتعامل فيها معكم",
            "الموقع سريع التحميل وسهل التصفح",
            "طريقة عرض المنتجات وتصنيفها ممتازة",
            "الاشتراك في النشرة البريدية يوفر عروض حصرية",
            "أشكركم على الخدمة المميزة والأسعار المعقولة",
            "سياسة الضمان واضحة وتعطي ثقة أكبر",
            "تعاملكم محترم وخدمتكم سريعة",
            "أنا سعيد جداً بتجربة الشراء من متجركم",
            "العروض الأسبوعية متجددة وقيمة",
            "المنتج وصل في وقت قياسي رغم العطلة",
            "سهولة تصفح الموقع من الهاتف المحمول",
            "التعامل راقي جداً من قسم المبيعات",
            "وصلني المنتج في عبوة أنيقة وفاخرة",
            "جودة التصوير للمنتجات ممتازة وتظهر التفاصيل",
            "وجدت كل ما أحتاجه في مكان واحد وبأسعار مناسبة",
            "سرعة التسجيل والدفع وفرت علي الكثير من الوقت",
            "التحديثات المستمرة للتطبيق تجعله أفضل باستمرار",
            "الإشعارات بالعروض الجديدة تأتي في الوقت المناسب",
            "خدمة التغليف كهدية رائعة ومتقنة",
            "التنظيم داخل المتجر يسهل الوصول للمنتجات",
            "موظفي المتجر يقدمون النصائح المفيدة",
            "نظام التقسيط مريح ويناسب ميزانيتي",
            "طريقة العرض تجعلني أرى كل التفاصيل قبل الشراء",
            "أسلوب خدمة العملاء محترم ومهذب جداً",
            "حصلت على خصم إضافي كعميل دائم، شكراً لكم",
            "الفروع متوفرة في معظم المناطق وهذا رائع",
            "كتالوج المنتجات متنوع ويلبي جميع الاحتياجات",
            "الحملات الترويجية قيمة وتوفر الكثير",
            "سعر الشحن معقول جداً مقارنة بحجم الطلب",
            "تم التعامل مع المنتج برعاية أثناء الشحن",
            "سهولة الحصول على الدعم الفني عند الحاجة",
            "منصة الدردشة المباشرة وفرت علي الكثير من الوقت",
            "طريقة تغليف المنتجات تحافظ عليها من التلف",
            "أقدر اهتمامكم بتفاصيل الطلب مهما كان صغيراً",
            "المنتجات على الموقع مصنفة بشكل منطقي وواضح",
            "تعدد وسائل الدفع يجعل الشراء أكثر مرونة",
            "خدمة التركيب السريعة والمجانية ميزة رائعة",
            "افتدت من العروض الحصرية للمشتركين",
            "وفرتم علي عناء البحث بتنوع منتجاتكم",
            "استقبلت اتصالاً لتأكيد الطلب، خدمة مميزة",
            "دليل الاستخدام مفصل وواضح ومترجم للعربية",
            "سعر المنتج يتناسب تماماً مع جودته العالية",
            "خدمة النقل والتركيب كانت سريعة ونظيفة",
            "تعامل الفني المختص كان احترافياً جداً",
            "المنتج يعمل بشكل ممتاز دون أي مشاكل فنية",
            "متجر يحترم وقت العميل ويقدم خدمة سريعة",
            "تحديثات حالة الطلب منتظمة ودقيقة",
            "الاستبدال تم بدون أي تعقيدات وبكل سهولة",
            "المنتج مطابق تماماً للمواصفات المذكورة",
            "خصوصية بياناتي محفوظة وهذا يزيد ثقتي بكم",
            "أسعار المنتجات تنافسية مقارنة بالسوق المحلي",
            "سرعة تجهيز الطلب والشحن ممتازة",
            "أمان عمليات الدفع الإلكتروني يشعرني بالراحة",
            "التعبئة والتغليف يحمي المنتج بشكل كامل",
            "الإرشادات داخل المتجر واضحة وسهلة الفهم",
            "المنتجات مرتبة حسب الفئات بشكل منطقي",
            "الخدمة الذاتية في المتجر سهلة وتوفر الوقت",
            "خدمة نقاط المكافآت تشجعني على الشراء المتكرر",
            "استلمت منتجي في نفس اليوم، خدمة سريعة",
            "العينات المجانية فكرة رائعة لتجربة المنتجات",
            "الضمان الطويل للمنتج يزيد ثقتي بجودته",
            "استبدال المنتج كان سهلاً ودون تعقيد",
            "الخصومات الموسمية حقيقية وليست وهمية",
            "نظام الولاء للعملاء يقدم مزايا حصرية",
            "المنتج مغلف بعناية ويحافظ على البيئة",
            "خدمة التوصيل المجدولة مفيدة جداً للمشغولين",
            "تقييمات المستخدمين الحقيقية ساعدتني في الاختيار",
            "سرعة حل المشاكل التقنية أثناء الشراء",
            "سعيد بعلاقتي طويلة الأمد مع متجركم",
            "تجربتي الأولى كانت ممتازة وستجعلني أعود",
            "توفرون مجموعة واسعة من المنتجات بأسعار منافسة",
            "خدمة ما بعد البيع تعزز ثقتي بمتجركم",
            "الإشعارات بوصول الطلب مفيدة ودقيقة",
            "خدمة التجربة قبل الشراء ميزة رائعة",
            "الفيديوهات التوضيحية للمنتج ساعدتني في اتخاذ القرار",
            "مركز المساعدة يقدم إجابات واضحة وسريعة",
            "عملية استرجاع المبالغ سريعة وبدون تعقيدات",
                        "المنتج يعمل تماماً كما هو موصوف على الموقع",
            "أحب تنبيهات الخصومات التي تصلني عبر البريد الإلكتروني",
            "خدمة التوصيل في نفس اليوم توفر الكثير من الوقت",
            "المنتج متين ومصنوع من مواد عالية الجودة",
            "الشكل الجمالي للتغليف يضيف قيمة للمنتج",
            "أسعاركم أقل من المتاجر الأخرى للمنتجات نفسها",
            "التعامل مع الشكاوى سريع ومهني",
            "التنبيهات حول حالة الطلب منتظمة ومفيدة",
            "الإجراءات الصحية في التغليف والتوصيل ممتازة",
            "عروضكم الترويجية دائماً قيّمة وحقيقية",
            "النصائح المقدمة من فريق المبيعات مفيدة جداً",
            "التطبيق يحفظ معلوماتي للشراء المستقبلي",
            "دائماً ما تكون المنتجات متوفرة في المخزون",
            "فرق التوصيل محترف ويحدد موعد الوصول مسبقاً",
            "الموقع محدّث دوماً بأحدث المنتجات",
            "ضمان استرجاع المال يعطيني ثقة أكبر",
            "صور المنتجات واضحة وتظهر جميع التفاصيل",
            "تفاصيل المنتج مكتوبة بدقة وشاملة",
            "خيارات التصفية والبحث تسهل إيجاد ما أريد",
            "التعامل مع المرتجعات كان سلساً ومرضياً",
            "شحن سريع وتتبع دقيق للطلبية",
            "خدمة العملاء متوفرة على مدار الساعة",
            "تجربة الشراء مريحة من البداية للنهاية",
            "الموقع آمن وموثوق به لإتمام عمليات الشراء",
            "تقديرات وقت التوصيل دقيقة جداً",
            "الأسئلة الشائعة على الموقع مفيدة ومفصلة",
            "التطبيق يعمل بسرعة حتى مع الاتصال الضعيف",
            "توفرون خيارات متعددة للمنتج الواحد",
            "الضمان الإضافي يستحق السعر الإضافي",
            "تجربة التسوق سهلة حتى بالنسبة للمبتدئين",
            "المنتج يستحق كل ريال دفعته فيه",
            "الطرود تصل دائماً بحالة ممتازة",
            "أقدر اهتمامكم بالتفاصيل الصغيرة في الخدمة",
            "السعر النهائي واضح بدون رسوم مخفية",
            "المنتجات الموصى بها ملائمة لاحتياجاتي",
            "ميزة المقارنة بين المنتجات مفيدة جداً",
            "تصميم العبوات أنيق ويناسب محتواها",
            "الخدمة الاستثنائية تميزكم عن المنافسين",
            "ميزة الدفع عند الاستلام مريحة جداً",
            "أحب الهدايا المجانية مع الطلبات الكبيرة",
            "تنوع المنتجات يجعلني أجد كل ما أحتاجه",
            "أقدر دقة مواعيد التوصيل التي تلتزمون بها",
            "الاستجابة السريعة للاستفسارات عبر الدردشة المباشرة",
            "جودة الخدمة تفوق توقعاتي دائماً",
            "تطابق المنتج مع الصور المعروضة بنسبة 100%",
            "الإشعارات بالتخفيضات الخاصة مفيدة جداً",
            "تنسيق الموقع يسهل عملية الشراء",
            "الدفع الآمن عبر الإنترنت يريحني كثيراً",
            "أحب أن كل تفاصيل المنتج موضحة بدقة",
            "مدة الضمان طويلة وتغطي معظم المشاكل",
            "أسعار الشحن معقولة جداً",
            "الإرشادات الواضحة لاستخدام المنتج",
            "المنتج محمي جيداً أثناء الشحن",
            "حصلت على نقاط ولاء عند كل عملية شراء",
            "واجهة الموقع بسيطة وغير معقدة",
            "الخصومات الخاصة بالعملاء الدائمين رائعة",
            "توفرون حلولاً سريعة لأي مشكلة تواجهني",
            "سعر المنتج يستحق جودته العالية",
                        "تقدمون تجربة تسوق احترافية بكل المقاييس",
            "التعبئة الصديقة للبيئة أمر أقدره كثيراً",
            "تأكيد الطلب عبر الرسائل النصية خدمة مميزة",
            "مندوب التوصيل كان مهذباً ومحترماً",
            "المنتج كان مغلفاً بطريقة احترافية تماماً",
            "سهولة تتبع الشحنة خطوة بخطوة",
            "التوصيل المجاني للطلبات فوق مبلغ معين ميزة رائعة",
            "أداء المنتج فاق التوقعات بكثير",
            "دقة وصف المنتج على الموقع ممتازة",
            "خيارات الدفع المتعددة تجعل التسوق أسهل",
            "سعر الشحن مناسب مقارنة بالمتاجر الأخرى",
            "استمتعت بتجربة التسوق من بدايتها لنهايتها",
            "المنتجات المعروضة حديثة ومواكبة للتطور",
            "خدمة تقسيط المدفوعات مفيدة جداً",
            "موظف المبيعات كان مطلعاً على تفاصيل المنتج",
            "أحب استلام المنتجات في اليوم التالي للطلب",
            "التنبيهات عن وصول منتجات جديدة مفيدة",
            "تجربة عملية الدفع الإلكتروني سلسة وآمنة",
            "جودة المنتج أفضل مما كنت أتوقع",
            "ردكم السريع على الاستفسارات أمر أقدره",
            "سعيد باختياري للتسوق من متجركم",
            "الخصومات الموسمية مجزية ومغرية",
            "أثق بمتجركم وبجودة منتجاتكم",
            "الحزم الخاصة توفر الكثير من المال",
            "المنتج أصلي وبجودة ممتازة",
            
            // Negative comments (140)
            "السعر غالي جداً مقارنة بالخدمة المقدمة",
            "تأخر الطلب أكثر من ساعتين وهذا غير مقبول",
            "جودة المنتج سيئة جداً ولن أشتري منكم مرة أخرى",
            "التطبيق بطيء جداً ويتوقف باستمرار",
            "الدعم الفني لا يرد على الاستفسارات نهائياً",
            "المنتج وصل تالف وغير صالح للاستخدام",
            "خدمة العملاء سيئة جداً ولا يوجد احترام للعميل",
            "الأسعار مرتفعة جداً مقارنة بالمواقع الأخرى",
            "تجربة سيئة جداً، لن أتعامل معكم مرة أخرى",
            "المنتج ليس كما هو موضح في الصور، خداع واضح",
            "طلبت المنتج منذ أسبوع ولم يصل بعد",
            "التطبيق يتعطل كثيراً ولا يمكنني إكمال عملية الشراء",
            "المنتج وصل ناقص والعناصر غير مكتملة",
            "التغليف سيء جداً والمنتج وصل مكسور",
            "سياسة الإرجاع معقدة جداً ولا يمكن استرداد الأموال بسهولة",
            "خدمة التوصيل بطيئة جداً ولا تلتزم بالمواعيد",
            "المنتج مقلد وليس أصلي كما تدعون",
            "الموقع بطيء جداً ويستغرق وقتاً طويلاً للتحميل",
            "التواصل مع خدمة العملاء صعب جداً ولا أحد يرد",
            "المنتج لا يعمل كما هو مفترض ولا يستحق السعر",
            "الدفع الإلكتروني لا يعمل بشكل صحيح وتم خصم المبلغ مرتين",
            "الشحن مكلف جداً ولا يتناسب مع سعر المنتج",
            "المنتج مختلف تماماً عما هو معروض في الصور",
            "العروض الموجودة على الموقع وهمية وغير حقيقية",
            "لا يوجد متابعة للطلب بعد الشراء",
            "خدمة ما بعد البيع سيئة جداً ولا يوجد ضمان حقيقي",
            "منتجاتكم غالية جداً ولا تستحق هذا السعر",
            "الموقع غير منظم ويصعب العثور على المنتجات",
            "المنتج وصل متأخراً جداً عن الموعد المحدد",
            "لا توجد تعليمات واضحة لاستخدام المنتج",
            "حجم المنتج أصغر مما هو موضح في الوصف",
            "تم خصم المبلغ ولم يتم تأكيد الطلب",
            "ندمت على الشراء من متجركم، تجربة سيئة",
            "الألوان مختلفة تماماً عما هو معروض في الصور",
            "التسجيل على الموقع مطلوب حتى لمجرد التصفح",
            "موظف خدمة العملاء كان وقحاً جداً معي",
            "أسعاركم غالية جداً مقارنة بالسوق",
            "المنتج لا يتطابق مع المواصفات المذكورة",
            "لن أنصح أحداً بالشراء من متجركم أبداً",
            "مشكلة في نظام الدفع تسببت في إلغاء طلبي",
            "لم يصلني إشعار بحالة الطلب ولا أعرف متى سيصل",
            "المنتج تالف رغم أنه مغلف جيداً",
            "وقت انتظار الرد على الشكاوى طويل جداً",
            "سياسة الضمان غير واضحة ومعقدة",
            "الشحن استغرق وقتاً أطول مما وعدتم به",
            "عملية الاسترجاع معقدة وتستغرق وقتاً طويلاً",
            "لا أستطيع التواصل مع فريق الدعم الفني",
            "المنتج لا يعمل بشكل جيد كما هو معلن عنه",
            "تجربة سيئة مع التطبيق، يتجمد كثيراً",
            "رسوم الشحن مرتفعة جداً ولم يتم الإعلان عنها مسبقاً",
            "المنتج الذي وصلني يختلف عما طلبته",
            "طلبي وصل ناقصاً والأغراض غير كاملة",
            "التعامل سيء جداً عند الإرجاع والاستبدال",
            "تأخر الرد على استفساراتي بشكل غير مقبول",
            "سعر المنتج غير مستحق مقارنة بالجودة المتدنية",
            "سياسة الخصوصية غير واضحة وتثير القلق",
            "كثرة الإعلانات على التطبيق مزعجة جداً",
            "تم تأكيد الدفع لكن لم يتم تأكيد الطلب",
            "التطبيق يعاني من مشاكل فنية مستمرة",
            "عملية التسجيل في الموقع معقدة وتستغرق وقتاً",
            "المنتج وصل متأخراً وبحالة سيئة",
            "التسجيل على الموقع مطلوب حتى لمجرد التصفح",
            "لا يوجد خيارات متنوعة للدفع",
            "صور المنتجات مضللة وغير دقيقة",
            "عملية الشراء معقدة وغير واضحة",
            "موظف التوصيل كان غير محترف وغير مهذب",
            "لم يعمل كود الخصم رغم أنه ساري المفعول",
            "عدم احترام خصوصية العميل أثناء التوصيل",
            "تلقيت اتصالات مزعجة بعد تسجيلي في الموقع",
            "سعر المنتج ارتفع فجأة عند إتمام الشراء",
            "الشحن المجاني مشروط بمبلغ كبير جداً",
            "المنتج الذي استلمته مستعمل وليس جديداً",
            "لم أتمكن من إلغاء الطلب رغم أنه لم يتم شحنه بعد",
            "التغليف غير آمن والمنتج تضرر أثناء الشحن",
            "العروض والخصومات تنتهي بسرعة قبل الاستفادة منها",
            "لا يوجد رقم هاتف للتواصل المباشر مع خدمة العملاء",
            "عملية استبدال المنتج استغرقت وقتاً طويلاً جداً",
            "العبوة لا تحمي المنتج وتعرض للكسر",
            "لم يتم تسليم الطلب في المكان المتفق عليه",
            "اضطررت للتواصل عدة مرات لمتابعة الطلب",
            "النظام المحاسبي معقد وغير واضح",
            "الموقع يواجه مشاكل فنية عند الذروة",
            "المنتج ليس بالجودة المتوقعة رغم سعره المرتفع",
            "تطبيق الهاتف يستهلك الكثير من بطارية الجوال",
            "نظام البحث في الموقع ضعيف ولا يعطي نتائج دقيقة",
            "الموقع يطلب معلومات شخصية كثيرة غير ضرورية",
            "خيارات الفلترة والتصفية محدودة جداً",
            "المنتج غير متوفر دائماً رغم ظهوره على الموقع",
            "تم خصم المبلغ مرتين عند إتمام عملية الشراء",
            "الإشعارات والرسائل الترويجية مزعجة ومتكررة",
            "لا يمكن حفظ المنتجات المفضلة في التطبيق",
            "صفحة الدفع تظهر أخطاء متكررة",
            "استلمت منتج مختلف تماماً عما طلبته",
            "التسجيل على الموقع مطلوب حتى لمجرد التصفح",
            "التطبيق يتوقف فجأة عند محاولة الدفع",
            "لا يوجد تنبيه عند وصول المنتجات المنتظرة",
            "تفاصيل المنتج غير كافية لاتخاذ قرار الشراء",
            "استغرق الشحن أكثر من 10 أيام رغم أنه داخل المدينة",
            "تم إلغاء طلبي دون إبلاغي بالسبب",
            "المنتج وصل بدون فاتورة أو ضمان",
            "الطلب غير مرتب وكأنه تم تجميعه بسرعة",
            "المنتج به عيوب تصنيع واضحة",
            "سعر التوصيل تغير عند إتمام الشراء",
            "موظف التوصيل طلب مبلغ إضافي غير متفق عليه",
            "لا يمكنني تعديل العنوان بعد تأكيد الطلب",
            "الضمان لا يغطي العيوب الأساسية في المنتج",
            "لم يتم الرد على شكواي نهائياً",
            "الموقع يواجه مشاكل فنية عند الذروة",
            "الموقع يعرض منتجات غير متوفرة حالياً",
            "التطبيق يطلب صلاحيات غير ضرورية على الجوال",
            "لا يمكن استخدام أكثر من كوبون خصم",
            "القطع المتوفرة للمنتج أقل جودة من المعروضة",
            "المقاسات غير دقيقة وأصغر من المقاسات القياسية",
            "طريقة عرض المنتج مضللة وتخفي العيوب",
            "المنتج يتعطل بعد فترة قصيرة من الاستخدام",
            "عملية استرداد المبلغ استغرقت أكثر من شهر",
            "المنتجات المعروضة قديمة وليست حديثة",
            "لا يوجد تطابق بين المنتج المستلم والموصوف",
            "طلبت منتج ووصلتني قطعة مختلفة تماماً",
            "أسلوب موظفي خدمة العملاء استفزازي",
            "رسوم الشحن تضاعفت عند الدفع النهائي",
            "تعبئة المنتج غير آمنة ووصل مكسوراً",
            "الإعلانات المضللة تظهر أسعار غير حقيقية",
            "لا يمكن إجراء تعديل على الطلب بعد تأكيده",
            "المنتج المستلم ليس بنفس الجودة المتوقعة",
            "كمية المنتج أقل مما هو معلن عنه",
            "المنتج تالف ويبدو مستعملاً",
            "إجراءات إرجاع المنتج معقدة ومرهقة",
            "التطبيق يستنزف بيانات الجوال بشكل كبير",
            "لا توجد خيارات شحن متعددة للاختيار منها",
            "تتعمدون تأخير الطلبات لفرض رسوم إضافية",
            "التغليف بسيط جداً ولا يحمي المنتج",
            "الموقع يواجه مشاكل فنية عند الذروة",
            "عروض الخصم وهمية وغير حقيقية",
            "قسم الأسئلة المتكررة لا يجيب على الاستفسارات الأساسية",
            "التعامل مع الشكاوى بطيء وغير فعال",
            "استغرق وصول المنتج أكثر من الوقت المتوقع",
            "الخصم المعلن عنه لا ينطبق على جميع المنتجات",
            "الوصف التفصيلي للمنتج غير دقيق",
            "لا يوجد استرجاع للمنتجات المعيبة",
            "التكلفة النهائية أعلى بكثير بسبب الضرائب الإضافية",
            "صعوبة التواصل مع قسم المبيعات",
            "لا يوجد دليل استخدام مرفق مع المنتج",
            "تغليف المنتج تالف وغير محمي",
            "آلية توصيل المنتجات غير منظمة",
            "جودة المنتج أقل بكثير من الموصوف",
            "تجربة الدعم الفني كانت محبطة",
            "لم أجد طريقة لإلغاء اشتراكي في النشرة البريدية",
            "الموقع يسجل بياناتي دون موافقتي",
            "تعامل سيء من قسم خدمة العملاء",
            "المنتج غير صالح للاستخدام وكأنه تالف",
            "الانتظار طويل للتواصل مع خدمة العملاء",
            "عملية الشراء معقدة وتستغرق وقتاً طويلاً",
            "المنتج لا يتطابق مع المواصفات التقنية المذكورة",
            "أعاني من مشاكل متكررة عند استخدام التطبيق",
            "توصيل المنتج للعنوان الخطأ رغم تأكيد العنوان",
            "عملية الدفع تفشل دائماً في المرحلة النهائية",
            "المنتج فائض الصلاحية وقارب على الانتهاء",
            "المنتج غير آمن للاستخدام وبه عيوب خطيرة",
            "لم يتم إخباري بتأخير الشحن حتى اتصلت للاستفسار",
            "العروض المعلنة غير متوفرة عند الطلب الفعلي",
            "الموقع يعاني من ثغرات أمنية واضحة"
        ];
    }


    // Update the example data button to use our large dataset
    const exampleDataBtn = document.getElementById('exampleDataBtn');
    exampleDataBtn.addEventListener('click', function() {
        const exampleData = getExampleDataset();
        
        document.getElementById('manualInput').value = exampleData.join('\n');
        
        // Create data structure
        const data = exampleData.map(line => ({ text: line }));
        
        csvData = data;
        selectedColumn = 'text';
        
        // Update UI
        updateDataStatistics(data);
        showDataPreview(data);
        
        // Update average length immediately for example data
        const avgLength = document.getElementById('avgLength');
        avgLength.textContent = calculateAverageTextLength(data, 'text');
        
        showToast('تم تحميل 100 تعليق كمثال', 'success');
    });
    
    // Analyze button
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.addEventListener('click', function() {
        if (!csvData.length || !selectedColumn) {
            showToast('يرجى تحميل البيانات واختيار عمود النص أولاً', 'warning');
            return;
        }
        
        // Update average length before processing
        const avgLength = document.getElementById('avgLength');
        avgLength.textContent = calculateAverageTextLength(csvData, selectedColumn);
        
        // Process the data
        processTextData();
        
        // Update the UI with analysis results
        updateAnalysisResults();
        
        // Switch to analysis tab
        document.querySelector('[data-tab="analysis"]').click();
        
        showToast('تم تحليل البيانات بنجاح', 'success');
    });
    
    // Export buttons
    const exportCSVBtn = document.getElementById('exportCSVBtn');
    exportCSVBtn.addEventListener('click', function() {
        if (!textData.length) {
            showToast('يرجى تحليل البيانات أولاً', 'warning');
            return;
        }
        
        exportToCSV();
    });
}

// Process text data for analysis
function processTextData() {
    textData = csvData.map(row => {
        const text = row[selectedColumn] || '';
        return {
            original: text,
            wordCount: text.split(/\s+/).filter(word => word.trim()).length,
            theme: detectTheme(text),
            sentiment: detectSentiment(text)
        };
    });
}

// Detect theme based on keywords
function detectTheme(text) {
    // Default theme if no match
    let detectedTheme = "غير مصنف";
    
    // Loop through each theme and its keywords
    for (const [theme, keywords] of Object.entries(themeData)) {
        // Check if any keyword exists in the text
        const matched = keywords.some(keyword => 
            text.includes(keyword) || 
            new RegExp(`\\b${keyword}\\b`, 'i').test(text)
        );
        
        if (matched) {
            detectedTheme = theme;
            break; // Stop at first theme match
        }
    }
    
    return detectedTheme;
}

    // Balanced sentiment detection function
    function detectSentiment(text) {
        if (!text || typeof text !== 'string') return "إيجابي";
        
        // Convert text to lowercase for case-insensitive matching
        const lowerText = text.toLowerCase();
        
        // Check if the text has explicit positive indicators first
        const strongPositivePatterns = [
            "ممتاز", "رائع", "جميل", "أحب", "شكراً", "يسلمو", "أفضل متجر", "سعيد جداً",
            "أنصح", "زبون دائم", "جودة عالية", "سريع جداً", "موثوقة", "سهل الاستخدام"
        ];
        
        let positiveCount = 0;
        for (const pattern of strongPositivePatterns) {
            if (lowerText.includes(pattern)) {
                positiveCount++;
            }
        }
        
        // If we have multiple strong positive indicators, it's probably positive
        if (positiveCount >= 2) {
            return "إيجابي";
        }
        
        // Strong negative indicators
        const strongNegativePatterns = [
            "سيئ", "سيئة", "سيء", "لن أشتري", "لن أتعامل", "لن أنصح", 
            "تجربة سيئة", "خدمة سيئة", "ندمت", "غير مقبول", "وقح", "وقحين",
            "مقلد", "خداع", "نصب", "تالف", "مكسور", "لا يعمل"
        ];
        
        // Check for strong negative patterns
        for (const pattern of strongNegativePatterns) {
            if (lowerText.includes(pattern)) {
                return "سلبي";
            }
        }
        
        // Additional negative patterns and phrases
        const negativePatterns = [
            "غالي جداً", "تأخر", "بطيء جداً", "لا يرد", "صعب جداً", 
            "لم يصل", "معقدة جداً", "مكلف جداً", "مختلف تماماً", "متأخراً جداً",
            "وهمية", "ليس كما هو موضح", "ناقص", "غير صالح للاستخدام"
        ];
        
        let negativeMatchCount = 0;
        
        // Count how many negative patterns appear in the text
        for (const pattern of negativePatterns) {
            if (lowerText.includes(pattern)) {
                negativeMatchCount++;
            }
        }
        
        // If there are multiple negative patterns, classify as negative
        if (negativeMatchCount >= 1) {
            return "سلبي";
        }
        
        // Specific negative phrase patterns that are highly indicative
        if (
            lowerText.includes("لا يوجد احترام") ||
            lowerText.includes("لا أحد يرد") ||
            lowerText.includes("خصم المبلغ مرتين") ||
            lowerText.includes("لم يتم تأكيد الطلب") ||
            (lowerText.includes("المنتج") && lowerText.includes("تالف")) ||
            (lowerText.includes("التطبيق") && lowerText.includes("يتوقف")) ||
            (lowerText.includes("العروض") && lowerText.includes("وهمية"))
        ) {
            return "سلبي";
        }
        
        // For specific types of complaints, we need the negative word to be directly related
        // to the topic, not just both words appearing somewhere in the text
        const negativeTopicPatterns = [
            { topic: "المنتج", negatives: ["غير", "لا", "ليس", "سيء", "رديء", "مقلد"] },
            { topic: "خدمة", negatives: ["سيئة", "غير", "لا", "ليس", "رديئة", "بطيئة"] },
            { topic: "الموقع", negatives: ["بطيء", "غير", "لا", "ليس", "معقد", "صعب"] },
            { topic: "التطبيق", negatives: ["بطيء", "غير", "لا", "ليس", "يتعطل", "يتعلق"] },
            { topic: "سعر", negatives: ["غالي", "مرتفع", "عالي", "مبالغ"] }
        ];
        
        // Check for topic-negative pairs within close proximity
        for (const { topic, negatives } of negativeTopicPatterns) {
            if (lowerText.includes(topic)) {
                const topicIndex = lowerText.indexOf(topic);
                
                // Look for negatives within a reasonable distance
                for (const negative of negatives) {
                    if (lowerText.includes(negative)) {
                        const negativeIndex = lowerText.indexOf(negative);
                        
                        // If negative word is within 20 characters of the topic, consider it related
                        if (Math.abs(topicIndex - negativeIndex) < 20) {
                            return "سلبي";
                        }
                    }
                }
            }
        }
        
        // If we have specific positive indicators, confirm it's positive
        if (
            lowerText.includes("ممتاز") ||
            lowerText.includes("رائع") ||
            lowerText.includes("جودة عالية") ||
            lowerText.includes("سريع") ||
            lowerText.includes("سهل الاستخدام") ||
            lowerText.includes("أنصح") ||
            lowerText.includes("شكراً") ||
            lowerText.includes("سعيد") ||
            (lowerText.includes("تجربة") && !lowerText.includes("سيئة"))
        ) {
            return "إيجابي";
        }
        
        // If text contains some mildly negative words but doesn't meet our criteria above,
        // we'll need to make a judgment call based on context
        if (
            lowerText.includes("غير") ||
            lowerText.includes("صعب") ||
            lowerText.includes("لا") ||
            lowerText.includes("ليس")
        ) {
            // Look at the context - if these negative words are closely followed by specific product attributes,
            // it may be negative
            if (
                lowerText.includes("غير أصلي") ||
                lowerText.includes("غير منظم") ||
                lowerText.includes("صعب الاستخدام") ||
                lowerText.includes("لا يستحق") ||
                lowerText.includes("ليس كما")
            ) {
                return "سلبي";
            }
        }
        
        // If nothing specific was detected, assume positive
        return "إيجابي";
    }
    
    // Update analysis results
    function updateAnalysisResults() {
        if (!textData.length) return;
        
        // Update counts
        document.getElementById('totalRecords').textContent = textData.length;
        
        // Count total words
        const totalWords = textData.reduce((sum, item) => sum + item.wordCount, 0);
        document.getElementById('totalWords').textContent = totalWords;
        
        // Get all words to find unique ones
        const allWords = textData
            .map(item => item.original.toLowerCase())
            .join(' ')
            .split(/\s+/)
            .filter(word => word.trim().length > 2); // Filter out short words
        
        // Count unique words
        const uniqueWordsCount = new Set(allWords).size;
        document.getElementById('uniqueWords').textContent = uniqueWordsCount;
        
        // Update sentiment counts
        const positiveCount = textData.filter(item => item.sentiment === "إيجابي").length;
        const negativeCount = textData.filter(item => item.sentiment === "سلبي").length;
        
        document.getElementById('positiveCount').textContent = positiveCount;
        document.getElementById('negativeCount').textContent = negativeCount;
        
        // Update negative expressions list
        updateNegativeExpressionsList();
        
        // Update top words table
        updateTopWordsTable(allWords);
        
        // Update repeated comments table
        updateRepeatedCommentsTable();
        
        // Create charts
        createWordCloudChart(allWords);
        createSentimentChart(positiveCount, negativeCount);
        createLengthDistributionChart();
        
        // Update theme distribution
        updateThemeDistribution();
    }
    
    // Update top words table
    function updateTopWordsTable(words) {
        const wordCountMap = {};
        
        // Count word frequencies
        words.forEach(word => {
            if (word.length > 2) { // Ignore very short words
                wordCountMap[word] = (wordCountMap[word] || 0) + 1;
            }
        });
        
        // Convert to array and sort by frequency
        const wordCountArray = Object.entries(wordCountMap)
            .map(([word, count]) => ({ word, count }))
            .sort((a, b) => b.count - a.count);
        
        // Get top N words (from input)
        const topWordsCount = parseInt(document.getElementById('topWordsCount').value) || 20;
        const topWords = wordCountArray.slice(0, topWordsCount);
        
        // Update table
        const tableBody = document.getElementById('topWordsTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (topWords.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.textContent = 'لا توجد بيانات للعرض';
            cell.className = 'py-2 px-2 text-gray-500 dark:text-gray-400 text-center';
            cell.colSpan = 2;
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
        }
        
        topWords.forEach(({ word, count }) => {
            const row = document.createElement('tr');
            
            const wordCell = document.createElement('td');
            wordCell.textContent = word;
            wordCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600';
            
            const countCell = document.createElement('td');
            countCell.textContent = count;
            countCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600 text-left';
            
            row.appendChild(wordCell);
            row.appendChild(countCell);
            tableBody.appendChild(row);
        });
    }
    
    // Update repeated comments table
    function updateRepeatedCommentsTable() {
        // Group similar comments
        const commentGroups = {};
        
        textData.forEach(item => {
            // Use first 10 words as a signature for similarity
            const signature = item.original.split(/\s+/).slice(0, 10).join(' ').toLowerCase();
            
            if (!commentGroups[signature]) {
                commentGroups[signature] = {
                    text: item.original,
                    count: 0
                };
            }
            
            commentGroups[signature].count++;
        });
        
        // Convert to array and sort by frequency
        const repeatedComments = Object.values(commentGroups)
            .filter(group => group.count > 1) // Only show comments that appear more than once
            .sort((a, b) => b.count - a.count);
        
        // Update table
        const tableBody = document.getElementById('repeatedCommentsTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (repeatedComments.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.textContent = 'لا توجد تعليقات متكررة';
            cell.className = 'py-2 px-2 text-gray-500 dark:text-gray-400 text-center';
            cell.colSpan = 2;
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
        }
        
        repeatedComments.forEach(({ text, count }) => {
            const row = document.createElement('tr');
            
            const textCell = document.createElement('td');
            textCell.textContent = text.length > 100 ? text.substring(0, 100) + '...' : text;
            textCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600';
            
            const countCell = document.createElement('td');
            countCell.textContent = count;
            countCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600 text-left';
            
            row.appendChild(textCell);
            row.appendChild(countCell);
            tableBody.appendChild(row);
        });
    }
    
    // Create word cloud chart
    function createWordCloudChart(words) {
        // Count word frequencies
        const wordCountMap = {};
        words.forEach(word => {
            if (word.length > 2) { // Ignore very short words
                wordCountMap[word] = (wordCountMap[word] || 0) + 1;
            }
        });
        
        // Convert to array and sort by frequency
        const wordCountArray = Object.entries(wordCountMap)
            .map(([text, value]) => ({ text, value }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 50); // Limit to top 50 words
        
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        
        // Get canvas element
        const canvas = document.getElementById('wordCloudChart');
        
        // Remove existing chart if any
        if (canvas.chart) {
            canvas.chart.destroy();
        }
        
        // Create a simple bar chart as a fallback for word cloud
        // (A real word cloud would require additional libraries)
        const ctx = canvas.getContext('2d');
        canvas.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: wordCountArray.slice(0, 15).map(item => item.text), // Only top 15 for readability
                datasets: [{
                    label: 'تكرار الكلمات',
                    data: wordCountArray.slice(0, 15).map(item => item.value),
                    backgroundColor: 'rgba(220, 38, 38, 0.7)',
                    borderColor: 'rgba(220, 38, 38, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal bar chart
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Create sentiment chart
    function createSentimentChart(positiveCount, negativeCount) {
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        
        // Get canvas element
        const canvas = document.getElementById('sentimentChart');
        
        // Remove existing chart if any
        if (canvas.chart) {
            canvas.chart.destroy();
        }
        
        // Create pie chart
        const ctx = canvas.getContext('2d');
        canvas.chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['إيجابي', 'سلبي'],
                datasets: [{
                    data: [positiveCount, negativeCount],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.7)', // Green for positive
                        'rgba(220, 38, 38, 0.7)'   // Red for negative
                    ],
                    borderColor: [
                        'rgba(16, 185, 129, 1)',
                        'rgba(220, 38, 38, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
    
    // Create length distribution chart
    function createLengthDistributionChart() {
        // Group comments by word count ranges
        const lengthRanges = {
            '1-5': 0,
            '6-10': 0,
            '11-20': 0,
            '21-30': 0,
            '31+': 0
        };
        
        textData.forEach(item => {
            const wordCount = item.wordCount;
            
            if (wordCount <= 5) lengthRanges['1-5']++;
            else if (wordCount <= 10) lengthRanges['6-10']++;
            else if (wordCount <= 20) lengthRanges['11-20']++;
            else if (wordCount <= 30) lengthRanges['21-30']++;
            else lengthRanges['31+']++;
        });
        
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        
        // Get canvas element
        const canvas = document.getElementById('lengthDistributionChart');
        
        // Remove existing chart if any
        if (canvas.chart) {
            canvas.chart.destroy();
        }
        
        // Create bar chart
        const ctx = canvas.getContext('2d');
        canvas.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(lengthRanges),
                datasets: [{
                    label: 'عدد التعليقات',
                    data: Object.values(lengthRanges),
                    backgroundColor: 'rgba(79, 70, 229, 0.7)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Update theme distribution
    function updateThemeDistribution() {
        // Count themes
        const themeCount = {};
        
        textData.forEach(item => {
            themeCount[item.theme] = (themeCount[item.theme] || 0) + 1;
        });
        
        // Convert to array and sort by frequency
        const themeCountArray = Object.entries(themeCount)
            .map(([theme, count]) => ({ theme, count }))
            .sort((a, b) => b.count - a.count);
        
        // Update table
        const tableBody = document.getElementById('themeDistributionTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (themeCountArray.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.textContent = 'لا توجد بيانات للعرض';
            cell.className = 'py-2 px-2 text-gray-500 dark:text-gray-400 text-center';
            cell.colSpan = 2;
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
        }
        
        themeCountArray.forEach(({ theme, count }) => {
            const row = document.createElement('tr');
            
            const themeCell = document.createElement('td');
            themeCell.textContent = theme;
            themeCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600';
            
            const percentCell = document.createElement('td');
            const percent = ((count / textData.length) * 100).toFixed(1) + '%';
            percentCell.textContent = percent;
            percentCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600 text-left';
            
            row.appendChild(themeCell);
            row.appendChild(percentCell);
            tableBody.appendChild(row);
        });
        
        // Create theme distribution chart
        createThemeDistributionChart(themeCountArray);
        
        // Setup theme selector
        setupThemeSelector(themeCountArray);
    }
    
    // Create theme distribution chart
    function createThemeDistributionChart(themeData) {
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        
        // Get canvas element
        const canvas = document.getElementById('themeDistributionChart');
        
        // Remove existing chart if any
        if (canvas.chart) {
            canvas.chart.destroy();
        }
        
        // Generate colors
        const colors = themeData.map((_, index) => {
            // Create a rainbow pattern of colors
            const hue = (index * 137) % 360; // Golden angle approximation for good distribution
            return `hsla(${hue}, 70%, 60%, 0.7)`;
        });
        
        const borderColors = colors.map(color => color.replace('0.7', '1'));
        
        // Create pie chart
        const ctx = canvas.getContext('2d');
        canvas.chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: themeData.map(item => item.theme),
                datasets: [{
                    data: themeData.map(item => item.count),
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'right',
                        rtl: true,
                        labels: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Setup theme selector
    function setupThemeSelector(themeData) {
        const themeSelector = document.getElementById('themeSelector');
        
        // Clear previous options
        themeSelector.innerHTML = '<option value="">-- اختر موضوعًا --</option>';
        
        // Add new options
        themeData.forEach(({ theme }) => {
            const option = document.createElement('option');
            option.value = theme;
            option.textContent = theme;
            themeSelector.appendChild(option);
        });
        
        // Handle theme selection
        themeSelector.addEventListener('change', function() {
            const selectedTheme = this.value;
            
            if (selectedTheme) {
                displayThemeDetails(selectedTheme);
            } else {
                // Clear theme details
                document.getElementById('themeDetails').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400"><p>اختر موضوعًا لعرض التفاصيل</p></div>';
                document.getElementById('themeCommentsTable').querySelector('tbody').innerHTML = '<tr><td class="py-2 px-2 text-gray-500 dark:text-gray-400 text-center" colspan="3">لا توجد بيانات للعرض</td></tr>';
            }
        });
    }
    
    // Display theme details
    function displayThemeDetails(theme) {
        // Get comments for this theme
        const themeComments = textData.filter(item => item.theme === theme);
        
        // Display count and sentiment distribution
        const themeDetailsElement = document.getElementById('themeDetails');
        
        const positiveCount = themeComments.filter(item => item.sentiment === "إيجابي").length;
        const negativeCount = themeComments.filter(item => item.sentiment === "سلبي").length;
        
        const positivePercent = ((positiveCount / themeComments.length) * 100).toFixed(1);
        const negativePercent = ((negativeCount / themeComments.length) * 100).toFixed(1);
        
        themeDetailsElement.innerHTML = `
            <div class="mb-3">
                <p class="font-medium text-gray-700 dark:text-gray-300">عدد التعليقات: <span class="font-bold text-red-600 dark:text-red-400">${themeComments.length}</span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">${positivePercent}% إيجابي, ${negativePercent}% سلبي</p>
            </div>
            
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${positivePercent}%"></div>
            </div>
            
            <h5 class="font-medium text-gray-700 dark:text-gray-300 text-sm mb-2">الكلمات المفتاحية:</h5>
            <div class="flex flex-wrap gap-2 mb-2">
                ${getThemeKeywords(theme).map(keyword => 
                    `<span class="px-2 py-1 bg-red-100 dark:bg-red-800/30 text-red-700 dark:text-red-300 rounded text-sm">${keyword}</span>`
                ).join('')}
            </div>
        `;
        
        // Display example comments
        displayThemeComments(themeComments);
    }
    
    // Get keywords for a theme
    function getThemeKeywords(theme) {
        // Return keywords from the themeData if available
        return themeData[theme] || [];
    }
    
    // Display theme comments
    function displayThemeComments(comments) {
        const tableBody = document.getElementById('themeCommentsTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (comments.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.textContent = 'لا توجد تعليقات للعرض';
            cell.className = 'py-2 px-2 text-gray-500 dark:text-gray-400 text-center';
            cell.colSpan = 3;
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
        }
        
        // Sort by sentiment (negative first) and then by length (longer first)
        const sortedComments = [...comments].sort((a, b) => {
            if (a.sentiment !== b.sentiment) {
                return a.sentiment === "سلبي" ? -1 : 1;
            }
            return b.wordCount - a.wordCount;
        });
        
        // Display up to 10 comments
        sortedComments.slice(0, 10).forEach(comment => {
            const row = document.createElement('tr');
            
            const textCell = document.createElement('td');
            textCell.textContent = comment.original;
            textCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600';
            
            const lengthCell = document.createElement('td');
            lengthCell.textContent = comment.wordCount;
            lengthCell.className = 'py-2 px-2 border-b border-gray-200 dark:border-gray-600 text-center';
            
            const sentimentCell = document.createElement('td');
            sentimentCell.textContent = comment.sentiment;
            sentimentCell.className = `py-2 px-2 border-b border-gray-200 dark:border-gray-600 text-center ${
                comment.sentiment === "سلبي" ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'
            }`;
            
            row.appendChild(textCell);
            row.appendChild(lengthCell);
            row.appendChild(sentimentCell);
            tableBody.appendChild(row);
        });
    }
    
    // Update negative expressions list
    function updateNegativeExpressionsList() {
        const negativeComments = textData.filter(item => item.sentiment === "سلبي");
        
        // Sort by word count (longer first)
        negativeComments.sort((a, b) => b.wordCount - a.wordCount);
        
        const listElement = document.getElementById('negativeExpressionsList');
        listElement.innerHTML = '';
        
        if (negativeComments.length === 0) {
            const listItem = document.createElement('li');
            listItem.textContent = 'لا توجد تعليقات سلبية';
            listItem.className = 'text-gray-500 dark:text-gray-400 text-center';
            listElement.appendChild(listItem);
            return;
        }
        
        // Display up to 10 negative comments
        negativeComments.slice(0, 10).forEach(comment => {
            const listItem = document.createElement('li');
            listItem.textContent = comment.original;
            listItem.className = 'text-red-600 dark:text-red-400';
            listElement.appendChild(listItem);
        });
    }
    
    // Export to CSV
    function exportToCSV() {
        if (!textData.length) return;
        
        // Prepare CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Headers
        csvContent += "التعليق,عدد الكلمات,الموضوع,المشاعر\n";
        
        // Data rows
        textData.forEach(item => {
            const escapedText = `"${item.original.replace(/"/g, '""')}"`;
            csvContent += `${escapedText},${item.wordCount},${item.theme},${item.sentiment}\n`;
        });
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "تحليل_النصوص.csv");
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        document.body.removeChild(link);
        
        showToast('تم تصدير البيانات بنجاح', 'success');
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        
        // Set color based on type
        let bgColor, textColor;
        
        switch (type) {
            case 'success':
                bgColor = 'bg-green-500';
                textColor = 'text-white';
                break;
            case 'error':
                bgColor = 'bg-red-500';
                textColor = 'text-white';
                break;
            case 'warning':
                bgColor = 'bg-yellow-500';
                textColor = 'text-white';
                break;
            default:
                bgColor = 'bg-blue-500';
                textColor = 'text-white';
        }
        
        // Set toast content and styling
        toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${bgColor} ${textColor}`;
        toast.textContent = message;
        
        // Show toast
        toast.classList.remove('hidden', 'translate-y-20');
        
        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-y-20');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }, 3000);
    }
    
    // Update current year in footer
    function updateCurrentYear() {
        const yearElement = document.getElementById('currentYear');
        if (yearElement) {
            yearElement.textContent = new Date().getFullYear();
        }
    }
    
    // Add additional event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Save report form
        const saveReportForm = document.getElementById('saveReportForm');
        if (saveReportForm) {
            saveReportForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Normally would save to server or localStorage
                // For this demo, just show a toast
                showToast('تم حفظ التقرير بنجاح', 'success');
                
                // Hide modal
                document.getElementById('saveReportModal').classList.add('hidden');
            });
        }
        
        // Open save report modal
        const exportPDFBtn = document.getElementById('exportPDFBtn');
        if (exportPDFBtn) {
            exportPDFBtn.addEventListener('click', function() {
                if (!textData.length) {
                    showToast('يرجى تحليل البيانات أولاً', 'warning');
                    return;
                }
                
                // Show modal
                document.getElementById('saveReportModal').classList.remove('hidden');
            });
        }
        
        // Close save report modal
        const closeSaveReportModal = document.getElementById('closeSaveReportModal');
        const cancelSaveReport = document.getElementById('cancelSaveReport');
        
        if (closeSaveReportModal && cancelSaveReport) {
            [closeSaveReportModal, cancelSaveReport].forEach(element => {
                element.addEventListener('click', function() {
                    document.getElementById('saveReportModal').classList.add('hidden');
                });
            });
        }
        
        // Top words count change
        const topWordsCount = document.getElementById('topWordsCount');
        if (topWordsCount) {
            topWordsCount.addEventListener('change', function() {
                if (textData.length > 0) {
                    // Re-run the analysis with the new count
                    const words = textData
                        .map(item => item.original.toLowerCase())
                        .join(' ')
                        .split(/\s+/)
                        .filter(word => word.trim().length > 2);
                        
                    updateTopWordsTable(words);
                }
            });
        }
    });

